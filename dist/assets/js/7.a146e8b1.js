(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{507:function(a,s,e){a.exports=e.p+"assets/img/image-20210716160951393.de0a0d90.png"},508:function(a,s,e){a.exports=e.p+"assets/img/image-20210716161418042.e19eb279.png"},509:function(a,s,e){a.exports=e.p+"assets/img/image-20210716163127323.a9a12625.png"},510:function(a,s,e){a.exports=e.p+"assets/img/image-20210716163725181.20bf183f.png"},511:function(a,s,e){a.exports=e.p+"assets/img/image-20210716163918107.ce041922.png"},512:function(a,s,e){a.exports=e.p+"assets/img/image-20210716164130511.3e4ca19a.png"},513:function(a,s,e){a.exports=e.p+"assets/img/image-20210716165325357.9d89bfba.png"},669:function(a,s,e){"use strict";e.r(s);var t=e(11),n=Object(t.a)({},(function(){var a=this,s=a.$createElement,t=a._self._c||s;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"主从复制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主从复制"}},[a._v("#")]),a._v(" 主从复制")]),a._v(" "),t("p",[a._v("配套仓库地址："),t("a",{attrs:{href:"https://gitee.com/orangbus/mysql-cluster",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://gitee.com/orangbus/mysql-cluster"),t("OutboundLink")],1)]),a._v(" "),t("p",[a._v("简单说就是：同时有两个mysql数据库服务，主服务（master）,从服务（slave），往master中写入的数据，slave会将master写入的数据同步到slave自己的服务器上，所以可以做读写分离的架构。")]),a._v(" "),t("p",[a._v("我的别名配置")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("# vim ~/.zshrc\n# ============= Base =============================\nalias cls=\"clear && ls\"\nalias RM='rm -rf'\nalias ll='ls -alh'\n# ============== docker ==========================\nalias dc='docker-compose'\nalias dca='dc up -d nginx phpmyadmin'\nalias dcps='docker-compose ps'\nalias dcres='docker-compose restart && dcps'\nalias dcn='docker-compose restart nginx && dcps'\nalias dcd='dc down'\n")])])]),t("h2",{attrs:{id:"启动服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动服务"}},[a._v("#")]),a._v(" 启动服务")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("dc")]),a._v(" up -d\n")])])]),t("p",[a._v("查看是否启动成功")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("dcps \n")])])]),t("p",[t("img",{attrs:{src:e(507),alt:"image-20210716160951393"}})]),a._v(" "),t("h2",{attrs:{id:"一、主服务配置-master"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、主服务配置-master"}},[a._v("#")]),a._v(" 一、主服务配置-master")]),a._v(" "),t("h3",{attrs:{id:"_1、master连接测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、master连接测试"}},[a._v("#")]),a._v(" 1、master连接测试")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("# 查看master状态\nSHOW MASTER STATUS\n")])])]),t("p",[t("img",{attrs:{src:e(508),alt:"image-20210716161418042"}})]),a._v(" "),t("p",[a._v("获取到这两个信息，slave需要用到")]),a._v(" "),t("h3",{attrs:{id:"_2、创建同步用户，并授权"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、创建同步用户，并授权"}},[a._v("#")]),a._v(" 2、创建同步用户，并授权")]),a._v(" "),t("p",[a._v("默认会创建一个用户，配置在当前文件的 "),t("code",[a._v(".env")]),a._v(" 中")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("# 创建一个同步的用户，该用户数据master节点，\nCREATE USER 'slaveuser'@'%' IDENTIFIED WITH mysql_native_password BY '123456';\n\n#授权用户slaveuser使用123456密码登录mysql\ngrant replication slave on *.* to 'slaveuser'@'%';\n\n#刷新配置\nflush privileges;\n")])])]),t("ul",[t("li",[a._v("需要注意的是，连接的地址是"),t("code",[a._v("容器的名称")]),a._v("，因为是在同一台服务器上运行的，如果是多台服务器填写对应的ip地址。")]),a._v(" "),t("li",[a._v("slave是当前"),t("code",[a._v("master服务")]),a._v("的用户，不是slave从服务器的用户，是"),t("code",[a._v("slave从服务")]),a._v("用于同步数据的账号。")])]),a._v(" "),t("p",[a._v("其它命令")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("#查看二进制日志相关的配置项\nshow global variables like 'binlog%';\n\n#查看server相关的配置项\nshow global variables like 'server%';\n")])])]),t("h2",{attrs:{id:"二、从服务配置-slave"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、从服务配置-slave"}},[a._v("#")]),a._v(" 二、从服务配置-slave")]),a._v(" "),t("p",[a._v("连接进入从服务器，设置master的相关信息")]),a._v(" "),t("h3",{attrs:{id:"_1、slave连接测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、slave连接测试"}},[a._v("#")]),a._v(" 1、slave连接测试")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("#查看slave状态\nshow slave status;\n")])])]),t("p",[t("img",{attrs:{src:e(509),alt:"image-20210716163127323"}})]),a._v(" "),t("h3",{attrs:{id:"_2、设置与master的关联信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、设置与master的关联信息"}},[a._v("#")]),a._v(" 2、设置与master的关联信息")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("# 1、先停止\nstop slave\n\n# 2、建立关联信息\nCHANGE MASTER TO\n\tmaster_host='mysql-master', # master的容器名称\n\tmaster_user='orangbus', # mster的同步账号\n\tmaster_password='123456',\n\tmaster_port=3306, # 同一台服务器是3306，如果是多台的话，那就是映射的端口（理论来讲）\n\tmaster_log_file='binlog.000002', # master步骤1获取\n\tmaster_log_pos=156;# master步骤1获取\n\n# 3、启动同步\nstart slave\n")])])]),t("p",[a._v("有时候启动同步会失败，那么可以执行一下重置")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("# 先停止\nstop slave\n\nreset slave;\n")])])]),t("p",[t("img",{attrs:{src:e(510),alt:"image-20210716163725181"}})]),a._v(" "),t("h3",{attrs:{id:"_3、查看是否配置成功"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、查看是否配置成功"}},[a._v("#")]),a._v(" 3、查看是否配置成功")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("show slave status\n")])])]),t("h1",{attrs:{id:"配置文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置文件"}},[a._v("#")]),a._v(" 配置文件")]),a._v(" "),t("h2",{attrs:{id:"master服务器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#master服务器"}},[a._v("#")]),a._v(" master服务器")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('[mysqld]\n#开启主从复制，主库的配置\nlog-bin=mysql-bin\n\n#指定主库serverid\nserver-id=1\n\n# 设置需要复制的数据库(可设置多个)\n# binlog-do-db=test\n\n# 设置不要复制的数据库(可设置多个)\nbinlog-ignore-db=sys\nbinlog-ignore-db=mysql\nbinlog-ignore-db=information_schema\nbinlog-ignore-db=performance_schema\n\n# 设置logbin格式\nbinlog_format=mixed\n\n# 处理报错\nsql-mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION"\ncharacter-set-server=utf8\n')])])]),t("h2",{attrs:{id:"slave-服务器配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#slave-服务器配置"}},[a._v("#")]),a._v(" slave 服务器配置")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('[mysqld]\n#开启主从复制，主库的配置\nlog-bin=mysql-bin\n\ndefault_authentication_plugin=mysql_native_password\n\n#指定主库serverid\nserver-id=2\n\n#指定同步的数据库，如果不指定则同步全部数据库\n# binlog-do-db=laravel\n\n## 复制过滤：也就是指定哪个数据库不用同步（mysql库一般不同步）\nbinlog-ignore-db=mysql\nbinlog-ignore-db=sys\nbinlog-ignore-db=information_schema\nbinlog-ignore-db=performance_schema\n\n## 主从复制的格式（mixed,statement,row，默认格式是statement）\nbinlog_format=mixed\n\n## 二进制日志自动删除/过期的天数。默认值为0，表示不自动删除。\nexpire_logs_days=7\n\n## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。\n## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致\nslave_skip_errors=1062\n\n# 处理报错\nsql-mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION"\ncharacter-set-server=utf8\n\n')])])]),t("h1",{attrs:{id:"问题排查"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题排查"}},[a._v("#")]),a._v(" 问题排查")]),a._v(" "),t("h2",{attrs:{id:"_1、slave连接失败"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、slave连接失败"}},[a._v("#")]),a._v(" 1、slave连接失败")]),a._v(" "),t("p",[t("img",{attrs:{src:e(511),alt:"image-20210716163918107"}})]),a._v(" "),t("p",[a._v("连接失败我们就去查看一下slave容器的日志：")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("dc logs mysql-slave\n")])])]),t("p",[t("img",{attrs:{src:e(512),alt:"image-20210716164130511"}})]),a._v(" "),t("p",[a._v("从日志中我们看出，应该是密码错误了，如果你们也遇到这个错误，那就检查一下 master的"),t("code",[a._v("端口")]),a._v(" "),t("code",[a._v("连接密码")])]),a._v(" "),t("p",[a._v("然后在执行 "),t("code",[a._v("2-2")]),a._v(" 的步骤")]),a._v(" "),t("h2",{attrs:{id:"_2、不知道什么错误"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、不知道什么错误"}},[a._v("#")]),a._v(" 2、不知道什么错误")]),a._v(" "),t("p",[t("img",{attrs:{src:e(513),alt:"image-20210716165325357.png"}})]),a._v(" "),t("p",[a._v("可能是更改了配置没有生效。")]),a._v(" "),t("p",[a._v("连接测试 master同步的账号是否能正常连接，是在不行，删除缓存数据，重头再来一遍")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("sudo rm -rf data/mysql/*\n")])])]),t("h2",{attrs:{id:"_3、同步授权失败"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3、同步授权失败"}},[a._v("#")]),a._v(" 3、同步授权失败")]),a._v(" "),t("blockquote",[t("p",[a._v("mysql-slave_1   | 2021-07-16T13:32:32.656444Z 17 [ERROR] [MY-010584] [Repl] Slave I/O for channel '': error connecting to master 'orangbus@mysql-master:3306' - retry-time: 60 retries: 2 message: Authentication plugin 'caching_sha2_password' reported error: Authentication requires secure connection. Error_code: MY-002061")])]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("set global max_connect_errors=1000;\n\nshow global variables like '%max_connect_errors%';\n")])])]),t("p",[a._v("参考链接：https://blog.csdn.net/wangbin9536/article/details/104150127")]),a._v(" "),t("h2",{attrs:{id:"_4、无法查看master状态信息"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4、无法查看master状态信息"}},[a._v("#")]),a._v(" 4、无法查看master状态信息")]),a._v(" "),t("p",[a._v("当我们去查看 "),t("code",[a._v("master")]),a._v(" 状态的时候，显示为空，查看mysql日志发现")]),a._v(" "),t("blockquote",[t("p",[a._v("Warning: World-writable config file '/etc/mysql/my.cnf' is ignored")])]),a._v(" "),t("p",[t("strong",[a._v("可能产生的原因：")]),a._v(" my.cnf 权限过高")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("644")]),a._v(" my.cnf\n")])])]),t("h2",{attrs:{id:"_5、踩坑指北"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5、踩坑指北"}},[a._v("#")]),a._v(" 5、踩坑指北")]),a._v(" "),t("p",[a._v("能复制的参数尽量复制，别手敲")]),a._v(" "),t("h1",{attrs:{id:"备注"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#备注"}},[a._v("#")]),a._v(" 备注")]),a._v(" "),t("p",[a._v("my.conf")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("# 需要同步的二进制数据库名\nbinlog-do-db=masterdemo\n\n# 只保留7天的二进制日志，以防磁盘被日志占满(可选)\nexpire-logs-days  = 7\n\n# 不备份的数据库\nbinlog-ignore-db=information_schema\nbinlog-ignore-db=performation_schema\nbinlog-ignore-db=sys\n")])])]),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("show slave status;\n\nstop slave\n\n# 2、建立关联信息\nCHANGE MASTER TO\n\tmaster_host='mysql-master', \n\tmaster_user='slave', \n\tmaster_password='slave666',\n\tmaster_port=3306, \n\tmaster_log_file='binlog.000004',\n\tmaster_log_pos=156;\n\nstart slave\n")])])]),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("global\n    log         127.0.0.1 local2\n    chroot      /var/lib/haproxy\n    pidfile     /var/run/haproxy.pid\n    maxconn     4000\n    user        haproxy\n    group       haproxy\n    daemon\n    stats socket /var/lib/haproxy/stats\ndefaults\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0/8\n    option                  redispatch\n    retries                 3\n    timeout http-request    10s\n    timeout queue           1m\n    timeout connect         10s\n    timeout client          1m\n    timeout server          1m\n    timeout http-keep-alive 10s\n    timeout check           10s\n    maxconn                 3000\n\nfrontend webservs\n    bind *:788\n    acl static path_beg -i /static /images /javascript /stylesheets\n    acl static path_end -i .jpg .gif .png .css .js .html\n    acl php path_end -i .php\n    use_backend static if static\n    use_backend dynamic if php\n    default_backend dynamic\n\nbackend static\n    balance roundrobin\n    server sta1 192.168.253.128:6080 check maxconn 3000\n    server sta2 192.168.253.128:7080 check maxconn 3000\n\nbackend dynamic\n    balance source\n    server dyn 192.168.253.128:7080 check maxconn 1000\n\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);