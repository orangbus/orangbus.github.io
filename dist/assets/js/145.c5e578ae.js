(window.webpackJsonp=window.webpackJsonp||[]).push([[145],{656:function(e,a,t){"use strict";t.r(a);var s=t(11),r=Object(s.a)({},(function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("blockquote",[t("p",[e._v("本文由 "),t("a",{attrs:{href:"http://ksria.com/simpread/",target:"_blank",rel:"noopener noreferrer"}},[e._v("简悦 SimpRead"),t("OutboundLink")],1),e._v(" 转码， 原文地址 "),t("a",{attrs:{href:"https://segmentfault.com/a/1190000021165798",target:"_blank",rel:"noopener noreferrer"}},[e._v("segmentfault.com"),t("OutboundLink")],1)])]),e._v(" "),t("h1",{attrs:{id:"关于-laravel项目多进程队列配置的使用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#关于-laravel项目多进程队列配置的使用"}},[e._v("#")]),e._v(" "),t("a",{attrs:{href:"/a/1190000021165798"}},[e._v("关于 Laravel项目多进程队列配置的使用")])]),e._v(" "),t("p",[e._v("[![][img-0]发布于 2019-12-02")]),e._v(" "),t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[e._v("#")]),e._v(" 前言:")]),e._v(" "),t("p",[e._v("近期随着队列在项目中的使用越来越多,单个队列的时间出来越来越长,单进程队列处理,会导致后面的队列被阻塞住,无法及时响应处理，便会造成不良好的用户体验和功能偏差。")]),e._v(" "),t("h2",{attrs:{id:"问题分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题分析"}},[e._v("#")]),e._v(" 问题分析")]),e._v(" "),t("p",[e._v("目前在我们使用的Laravel项目中,使用的广播服务是redis,每次向客户端广播一次,都会生成一条Queue,假设每个Queue的执行时间是1秒,假设用户执行以下操作:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("//推送即时点赞提醒 1s\ndispatch(new NewLike($like));\n//推送即时评论提醒 1s\ndispatch(new NewComment($comment));\n//推送即时回复提醒 1s\ndispatch(new NewReply($reply));\n//推送即时通知提醒 1s\ndispatch(new NewNotite($notice));\n//推送即时消息提醒 1s\ndispatch(new NewMessage($message));\n")])])]),t("p",[e._v("以上每个推送都将会耗时1秒以上,5个通知执行完成则需要5秒,假设系统每天产生10000次推送,则处理推送的时间10000 / 60 / 60 = 2.8(小时),则系统则需要花费2.8个小时才能将消息全部推送完成,可能会导致部分用户无法及时推送,从而对APP体验产生反感。")]),e._v(" "),t("p",[e._v("随着系统推送越来越多,单进程队列以及无法满足我们的需求,此时便需要开启多个队列消费者来进行处理。")]),e._v(" "),t("h2",{attrs:{id:"解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[e._v("#")]),e._v(" 解决方案")]),e._v(" "),t("p",[e._v("开启多个队列消费者,就需要使用到多线程,每个一个"),t("code",[e._v("queue:work")]),e._v("都是一个单独的进程,运行多个"),t("code",[e._v("queue:work")]),e._v("进程就可以达到同时处理多个任务的效果。")]),e._v(" "),t("p",[e._v("说了那么多,上个代码测试一下。")]),e._v(" "),t("h3",{attrs:{id:"_1-新建一个job"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-新建一个job"}},[e._v("#")]),e._v(" 1.新建一个JOB")]),e._v(" "),t("p",[e._v("通过artisan命令创建")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("art make:job TestJob\n")])])]),t("p",[e._v("完善一下Job的主要逻辑:延迟1秒将传入的ID写入到日志到中。")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("<?php\n\nnamespace App\\Jobs;\n\nuse Illuminate\\Bus\\Queueable;\nuse Illuminate\\Contracts\\Queue\\ShouldQueue;\nuse Illuminate\\Foundation\\Bus\\Dispatchable;\nuse Illuminate\\Queue\\InteractsWithQueue;\nuse Illuminate\\Queue\\SerializesModels;\n\nclass TestJob implements ShouldQueue\n{\n    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;\n\n    public $id;\n\n    /**\n     * Create a new job instance.\n     *\n     * @return void\n     */\n    public function __construct($id)\n    {\n        $this->id = $id;\n    }\n\n    /**\n     * Execute the job.\n     *\n     * @return void\n     */\n    public function handle()\n    {\n        sleep(1);\n        info($this->id);\n    }\n}\n\n")])])]),t("h3",{attrs:{id:"_2-填充测试数据"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-填充测试数据"}},[e._v("#")]),e._v(" 2.填充测试数据")]),e._v(" "),t("p",[e._v("我本地环境使用的job是基于mysql database,目前先填充10000个job进去。")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("for ($i = 0; $i < 10000; $i++) {\n    dispatch(new TestJob($i));\n}\n\ndd('done');\n")])])]),t("h3",{attrs:{id:"_3-运行-测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-运行-测试"}},[e._v("#")]),e._v(" 3.运行 && 测试")]),e._v(" "),t("p",[e._v("针对这10000个job,我本地运行了两个"),t("code",[e._v("queue:work")]),e._v("进程来进行同时处理。")]),e._v(" "),t("p",[e._v("由于本地运行测试,为了方便,便把sleep移除了，下面来看看效果。")]),e._v(" "),t("p",[e._v("10000个job很快就被两个"),t("code",[e._v("queue:work")]),e._v("处理完成了。")]),e._v(" "),t("p",[e._v("运行完成后,最担心的问题莫过于,队列任务是否会被另一个消费者进行重复执行?")]),e._v(" "),t("p",[e._v("答案就是:不会,除非是其中一个任务处理超时(timeout)才会有可能被其他队列进程重复执行到,关于为什么不会,下次将会通过写一篇源码解析来为大家揭晓。")]),e._v(" "),t("h3",{attrs:{id:"_4-优化到supervisor中"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-优化到supervisor中"}},[e._v("#")]),e._v(" 4.优化到Supervisor中")]),e._v(" "),t("p",[e._v("通常在服务端我们使用的队列进程管理工具一半都是Supervisor,知道上面需要开启多个进程处理后,部分同学便认为只需要添加多个conf配置文件,就完成啦。")]),e._v(" "),t("p",[e._v("但是当我们需要添加的队列进程从2个变成8个、10个、20个、32个、64个。。。随着需要处理的越来越多,岂不是需要添加n个配置文件来保持多进程队列运行。")]),e._v(" "),t("p",[e._v("其实不是这样的,Supervisor早就做到了这一点,可以通过"),t("strong",[e._v("numprocs")]),e._v("来控制进程数量进行处理,你可以根据服务端负载情况,来动态调整进程数量,配置如下:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("[program:laravel-queue-work]\nprocess_name=%(program_name)s_%(process_num)02d\ndirectory=/data/yoursite\ncommand=php artisan queue:work\nautostart=true\nautorestart=true\nuser=www\nnumprocs=32\nredirect_stderr=true\n")])])]),t("p",[e._v("上面的案例中就开启了32个进程进行同时处理了job。")]),e._v(" "),t("h2",{attrs:{id:"结论"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结论"}},[e._v("#")]),e._v(" 结论")]),e._v(" "),t("p",[e._v("以上就完成laravel项目多进程队列的配置使用,同时从"),t("code",[e._v("queue:work")]),e._v("输出和日志的写入来看,多个进程同时运行,也并不会造成队列重复执行的问题,可以放心使用😁😁")]),e._v(" "),t("p",[t("a",{attrs:{href:"/t/laravel"}},[e._v("laravel")]),t("a",{attrs:{href:"/t/php"}},[e._v("php")]),t("a",{attrs:{href:"/t/%E9%98%9F%E5%88%97"}},[e._v("队列")]),t("a",{attrs:{href:"/t/supervisor"}},[e._v("supervisor")]),t("a",{attrs:{href:"/t/%E5%A4%9A%E8%BF%9B%E7%A8%8B"}},[e._v("多进程")]),e._v("阅读 6.1k发布于 2019-12-02 赞5收藏3"),t("a",{attrs:{href:"###"}},[e._v("分享")]),e._v("本作品系原创，"),t("a",{attrs:{href:"https://creativecommons.org/licenses/by-nc-nd/4.0/",target:"_blank",rel:"noopener noreferrer"}},[e._v("采用《署名-非商业性使用-禁止演绎 4.0 国际》许可协议"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("[img-0]:data:application/json;base64,eyJjb2RlIjo0MDAxMDAzOCwibXNnIjoidW5rbm93biB0aHVtYi1jbWQiLCJpZCI6IjI5MTg5MzdiLTQzMmUtNDMzNi04OTNlLTI3NzY2MWJjNWFhMSJ9")])])}),[],!1,null,null,null);a.default=r.exports}}]);